/**************************************************************************/
/*!
Phantom Driver using I2C for analog signal generation

Based on example from Adafruit MCP4725

Updated October 23rd to have a second lookup table for HPIs w 1/3 regular voltage.
*/
/**************************************************************************/
#include <Wire.h>
#include <Adafruit_MCP4725.h>
Adafruit_MCP4725 dac;

// Phantom driver settings
int numTrials = 3;
int ISI = 200; //time between activations, milliseconds
int switchingDelay = 1000; //time between switching from line to line, milliseconds
int outPin = 9;     // Start on pin 9 (relay 1)
                    // Note relays increment as outPin decrements
                    // D9 is Relay 1
                    // D2 is Relay 8
int lastPin = 2;    // Pin to end on (can be changed to send to less than 8 lines)

// Some system variables
int state = 0;      // Initial state for state machine
int trialIndex = 0; // Initial trial index

// Lookup table for inverted cosine wave (driver signal)
const PROGMEM uint16_t COS_Lookup_12bit[1280]=
{
0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 2, 2, 3, 4, 4, 5, 6, 7, 7, 8, 9, 10, 11, 13, 14, 15, 16, 17, 19, 20, 22, 23, 25, 26, 28, 30, 31, 33, 35, 37, 39, 41, 43, 45, 47, 49, 51, 54, 56, 58, 61, 63, 66, 68, 71, 74, 76, 79, 82, 85, 88, 91, 94, 97, 100, 103, 106, 109, 113, 116, 119, 123, 126, 130, 133, 137, 140, 144, 148, 152, 155, 159, 163, 167, 171, 175, 179, 183, 188, 192, 196, 200, 205, 209, 214, 218, 223, 227, 232, 237, 241, 246, 251, 256, 261, 265, 270, 275, 281, 286, 291, 296, 301, 306, 312, 317, 323, 328, 333, 339, 345, 350, 356, 362, 367, 373, 379, 385, 391, 396, 402, 408, 414, 421, 427, 433, 439, 445, 452, 458, 464, 471, 477, 484, 490, 497, 503, 510, 516, 523, 530, 537, 543, 550, 557, 564, 571, 578, 585, 592, 599, 606, 613, 621, 628, 635, 642, 650, 657, 665, 672, 679, 687, 694, 702, 710, 717, 725, 733, 740, 748, 756, 764, 772, 779, 787, 795, 803, 811, 819, 827, 835, 844, 852, 860, 868, 876, 885, 893, 901, 909, 918, 926, 935, 943, 952, 960, 969, 977, 986, 994, 1003, 1012, 1020, 1029, 1038, 1047, 1055, 1064, 1073, 1082, 1091, 1100, 1109, 1117, 1126, 1135, 1144, 1153, 1163, 1172, 1181, 1190, 1199, 1208, 1217, 1226, 1236, 1245, 1254, 1263, 1273, 1282, 1291, 1301, 1310, 1320, 1329, 1338, 1348, 1357, 1367, 1376, 1386, 1395, 1405, 1414, 1424, 1433, 1443, 1453, 1462, 1472, 1482, 1491, 1501, 1511, 1520, 1530, 1540, 1549, 1559, 1569, 1579, 1589, 1598, 1608, 1618, 1628, 1638, 1648, 1657, 1667, 1677, 1687, 1697, 1707, 1717, 1727, 1737, 1747, 1757, 1766, 1776, 1786, 1796, 1806, 1816, 1826, 1836, 1846, 1856, 1866, 1876, 1886, 1896, 1906, 1916, 1926, 1936, 1947, 1957, 1967, 1977, 1987, 1997, 2007, 2017, 2027, 2037, 2047, 2057, 2067, 2077, 2087, 2097, 2107, 2117, 2127, 2137, 2147, 2158, 2168, 2178, 2188, 2198, 2208, 2218, 2228, 2238, 2248, 2258, 2268, 2278, 2288, 2298, 2308, 2318, 2328, 2337, 2347, 2357, 2367, 2377, 2387, 2397, 2407, 2417, 2427, 2437, 2446, 2456, 2466, 2476, 2486, 2496, 2505, 2515, 2525, 2535, 2545, 2554, 2564, 2574, 2583, 2593, 2603, 2612, 2622, 2632, 2641, 2651, 2661, 2670, 2680, 2689, 2699, 2708, 2718, 2727, 2737, 2746, 2756, 2765, 2774, 2784, 2793, 2803, 2812, 2821, 2831, 2840, 2849, 2858, 2868, 2877, 2886, 2895, 2904, 2913, 2922, 2931, 2941, 2950, 2959, 2968, 2977, 2985, 2994, 3003, 3012, 3021, 3030, 3039, 3047, 3056, 3065, 3074, 3082, 3091, 3100, 3108, 3117, 3125, 3134, 3142, 3151, 3159, 3168, 3176, 3185, 3193, 3201, 3209, 3218, 3226, 3234, 3242, 3250, 3259, 3267, 3275, 3283, 3291, 3299, 3307, 3315, 3322, 3330, 3338, 3346, 3354, 3361, 3369, 3377, 3384, 3392, 3400, 3407, 3415, 3422, 3429, 3437, 3444, 3452, 3459, 3466, 3473, 3481, 3488, 3495, 3502, 3509, 3516, 3523, 3530, 3537, 3544, 3551, 3557, 3564, 3571, 3578, 3584, 3591, 3597, 3604, 3610, 3617, 3623, 3630, 3636, 3642, 3649, 3655, 3661, 3667, 3673, 3680, 3686, 3692, 3698, 3703, 3709, 3715, 3721, 3727, 3732, 3738, 3744, 3749, 3755, 3761, 3766, 3771, 3777, 3782, 3788, 3793, 3798, 3803, 3808, 3813, 3819, 3824, 3829, 3833, 3838, 3843, 3848, 3853, 3857, 3862, 3867, 3871, 3876, 3880, 3885, 3889, 3894, 3898, 3902, 3906, 3911, 3915, 3919, 3923, 3927, 3931, 3935, 3939, 3942, 3946, 3950, 3954, 3957, 3961, 3964, 3968, 3971, 3975, 3978, 3981, 3985, 3988, 3991, 3994, 3997, 4000, 4003, 4006, 4009, 4012, 4015, 4018, 4020, 4023, 4026, 4028, 4031, 4033, 4036, 4038, 4040, 4043, 4045, 4047, 4049, 4051, 4053, 4055, 4057, 4059, 4061, 4063, 4064, 4066, 4068, 4069, 4071, 4072, 4074, 4075, 4077, 4078, 4079, 4080, 4081, 4083, 4084, 4085, 4086, 4087, 4087, 4088, 4089, 4090, 4090, 4091, 4092, 4092, 4093, 4093, 4093, 4094, 4094, 4094, 4094, 4094, 4094, 4095, 4094, 4094, 4094, 4094, 4094, 4094, 4093, 4093, 4093, 4092, 4092, 4091, 4090, 4090, 4089, 4088, 4087, 4087, 4086, 4085, 4084, 4083, 4081, 4080, 4079, 4078, 4077, 4075, 4074, 4072, 4071, 4069, 4068, 4066, 4064, 4063, 4061, 4059, 4057, 4055, 4053, 4051, 4049, 4047, 4045, 4043, 4040, 4038, 4036, 4033, 4031, 4028, 4026, 4023, 4020, 4018, 4015, 4012, 4009, 4006, 4003, 4000, 3997, 3994, 3991, 3988, 3985, 3981, 3978, 3975, 3971, 3968, 3964, 3961, 3957, 3954, 3950, 3946, 3942, 3939, 3935, 3931, 3927, 3923, 3919, 3915, 3911, 3906, 3902, 3898, 3894, 3889, 3885, 3880, 3876, 3871, 3867, 3862, 3857, 3853, 3848, 3843, 3838, 3833, 3829, 3824, 3819, 3813, 3808, 3803, 3798, 3793, 3788, 3782, 3777, 3771, 3766, 3761, 3755, 3749, 3744, 3738, 3732, 3727, 3721, 3715, 3709, 3703, 3698, 3692, 3686, 3680, 3673, 3667, 3661, 3655, 3649, 3642, 3636, 3630, 3623, 3617, 3610, 3604, 3597, 3591, 3584, 3578, 3571, 3564, 3557, 3551, 3544, 3537, 3530, 3523, 3516, 3509, 3502, 3495, 3488, 3481, 3473, 3466, 3459, 3452, 3444, 3437, 3429, 3422, 3415, 3407, 3400, 3392, 3384, 3377, 3369, 3361, 3354, 3346, 3338, 3330, 3322, 3315, 3307, 3299, 3291, 3283, 3275, 3267, 3259, 3250, 3242, 3234, 3226, 3218, 3209, 3201, 3193, 3185, 3176, 3168, 3159, 3151, 3142, 3134, 3125, 3117, 3108, 3100, 3091, 3082, 3074, 3065, 3056, 3047, 3039, 3030, 3021, 3012, 3003, 2994, 2985, 2977, 2968, 2959, 2950, 2941, 2931, 2922, 2913, 2904, 2895, 2886, 2877, 2868, 2858, 2849, 2840, 2831, 2821, 2812, 2803, 2793, 2784, 2774, 2765, 2756, 2746, 2737, 2727, 2718, 2708, 2699, 2689, 2680, 2670, 2661, 2651, 2641, 2632, 2622, 2612, 2603, 2593, 2583, 2574, 2564, 2554, 2545, 2535, 2525, 2515, 2505, 2496, 2486, 2476, 2466, 2456, 2446, 2437, 2427, 2417, 2407, 2397, 2387, 2377, 2367, 2357, 2347, 2337, 2328, 2318, 2308, 2298, 2288, 2278, 2268, 2258, 2248, 2238, 2228, 2218, 2208, 2198, 2188, 2178, 2168, 2158, 2147, 2137, 2127, 2117, 2107, 2097, 2087, 2077, 2067, 2057, 2047, 2037, 2027, 2017, 2007, 1997, 1987, 1977, 1967, 1957, 1947, 1936, 1926, 1916, 1906, 1896, 1886, 1876, 1866, 1856, 1846, 1836, 1826, 1816, 1806, 1796, 1786, 1776, 1766, 1757, 1747, 1737, 1727, 1717, 1707, 1697, 1687, 1677, 1667, 1657, 1648, 1638, 1628, 1618, 1608, 1598, 1589, 1579, 1569, 1559, 1549, 1540, 1530, 1520, 1511, 1501, 1491, 1482, 1472, 1462, 1453, 1443, 1433, 1424, 1414, 1405, 1395, 1386, 1376, 1367, 1357, 1348, 1338, 1329, 1320, 1310, 1301, 1291, 1282, 1273, 1263, 1254, 1245, 1236, 1226, 1217, 1208, 1199, 1190, 1181, 1172, 1163, 1153, 1144, 1135, 1126, 1117, 1109, 1100, 1091, 1082, 1073, 1064, 1055, 1047, 1038, 1029, 1020, 1012, 1003, 994, 986, 977, 969, 960, 952, 943, 935, 926, 918, 909, 901, 893, 885, 876, 868, 860, 852, 844, 835, 827, 819, 811, 803, 795, 787, 779, 772, 764, 756, 748, 740, 733, 725, 717, 710, 702, 694, 687, 679, 672, 665, 657, 650, 642, 635, 628, 621, 613, 606, 599, 592, 585, 578, 571, 564, 557, 550, 543, 537, 530, 523, 516, 510, 503, 497, 490, 484, 477, 471, 464, 458, 452, 445, 439, 433, 427, 421, 414, 408, 402, 396, 391, 385, 379, 373, 367, 362, 356, 350, 345, 339, 333, 328, 323, 317, 312, 306, 301, 296, 291, 286, 281, 275, 270, 265, 261, 256, 251, 246, 241, 237, 232, 227, 223, 218, 214, 209, 205, 200, 196, 192, 188, 183, 179, 175, 171, 167, 163, 159, 155, 152, 148, 144, 140, 137, 133, 130, 126, 123, 119, 116, 113, 109, 106, 103, 100, 97, 94, 91, 88, 85, 82, 79, 76, 74, 71, 68, 66, 63, 61, 58, 56, 54, 51, 49, 47, 45, 43, 41, 39, 37, 35, 33, 31, 30, 28, 26, 25, 23, 22, 20, 19, 17, 16, 15, 14, 13, 11, 10, 9, 8, 7, 7, 6, 5, 4, 4, 3, 2, 2, 1, 1, 1, 0, 0, 0, 0, 0, 0 
};

const PROGMEM uint16_t COS_Lookup_12bit_thirdScale[1280]=
{
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 4, 4, 5, 5, 5, 6, 6, 7, 7, 8, 8, 9, 10, 10, 11, 11, 12, 13, 13, 14, 15, 15, 16, 17, 18, 18, 19, 20, 21, 22, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 48, 49, 50, 51, 53, 54, 55, 57, 58, 59, 61, 62, 64, 65, 66, 68, 69, 71, 72, 74, 75, 77, 79, 80, 82, 83, 85, 87, 88, 90, 91, 93, 95, 97, 98, 100, 102, 104, 105, 107, 109, 111, 113, 115, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 144, 146, 148, 150, 152, 154, 157, 159, 161, 163, 165, 167, 170, 172, 174, 176, 179, 181, 183, 185, 188, 190, 192, 195, 197, 199, 202, 204, 207, 209, 211, 214, 216, 219, 221, 224, 226, 229, 231, 234, 236, 239, 241, 244, 246, 249, 252, 254, 257, 259, 262, 265, 267, 270, 273, 275, 278, 281, 284, 286, 289, 292, 295, 297, 300, 303, 306, 308, 311, 314, 317, 320, 323, 325, 328, 331, 334, 337, 340, 343, 346, 349, 351, 354, 357, 360, 363, 366, 369, 372, 375, 378, 381, 384, 387, 390, 393, 396, 399, 402, 405, 408, 412, 415, 418, 421, 424, 427, 430, 433, 436, 440, 443, 446, 449, 452, 455, 458, 462, 465, 468, 471, 474, 477, 481, 484, 487, 490, 494, 497, 500, 503, 506, 510, 513, 516, 519, 523, 526, 529, 532, 536, 539, 542, 546, 549, 552, 555, 559, 562, 565, 569, 572, 575, 579, 582, 585, 588, 592, 595, 598, 602, 605, 608, 612, 615, 618, 622, 625, 628, 632, 635, 638, 642, 645, 649, 652, 655, 659, 662, 665, 669, 672, 675, 679, 682, 685, 689, 692, 695, 699, 702, 705, 709, 712, 715, 719, 722, 726, 729, 732, 736, 739, 742, 746, 749, 752, 756, 759, 762, 766, 769, 772, 776, 779, 782, 785, 789, 792, 795, 799, 802, 805, 809, 812, 815, 818, 822, 825, 828, 832, 835, 838, 841, 845, 848, 851, 854, 858, 861, 864, 867, 870, 874, 877, 880, 883, 887, 890, 893, 896, 899, 902, 906, 909, 912, 915, 918, 921, 924, 928, 931, 934, 937, 940, 943, 946, 949, 952, 956, 959, 962, 965, 968, 971, 974, 977, 980, 983, 986, 989, 992, 995, 998, 1001, 1004, 1007, 1010, 1013, 1015, 1018, 1021, 1024, 1027, 1030, 1033, 1036, 1039, 1041, 1044, 1047, 1050, 1053, 1056, 1058, 1061, 1064, 1067, 1069, 1072, 1075, 1078, 1080, 1083, 1086, 1089, 1091, 1094, 1097, 1099, 1102, 1105, 1107, 1110, 1112, 1115, 1118, 1120, 1123, 1125, 1128, 1130, 1133, 1135, 1138, 1140, 1143, 1145, 1148, 1150, 1153, 1155, 1157, 1160, 1162, 1165, 1167, 1169, 1172, 1174, 1176, 1179, 1181, 1183, 1185, 1188, 1190, 1192, 1194, 1197, 1199, 1201, 1203, 1205, 1207, 1210, 1212, 1214, 1216, 1218, 1220, 1222, 1224, 1226, 1228, 1230, 1232, 1234, 1236, 1238, 1240, 1242, 1244, 1246, 1248, 1249, 1251, 1253, 1255, 1257, 1259, 1260, 1262, 1264, 1266, 1267, 1269, 1271, 1273, 1274, 1276, 1277, 1279, 1281, 1282, 1284, 1285, 1287, 1289, 1290, 1292, 1293, 1295, 1296, 1298, 1299, 1300, 1302, 1303, 1305, 1306, 1307, 1309, 1310, 1311, 1313, 1314, 1315, 1316, 1318, 1319, 1320, 1321, 1322, 1323, 1325, 1326, 1327, 1328, 1329, 1330, 1331, 1332, 1333, 1334, 1335, 1336, 1337, 1338, 1339, 1340, 1341, 1342, 1342, 1343, 1344, 1345, 1346, 1346, 1347, 1348, 1349, 1349, 1350, 1351, 1351, 1352, 1353, 1353, 1354, 1354, 1355, 1356, 1356, 1357, 1357, 1358, 1358, 1359, 1359, 1359, 1360, 1360, 1361, 1361, 1361, 1362, 1362, 1362, 1362, 1363, 1363, 1363, 1363, 1364, 1364, 1364, 1364, 1364, 1364, 1364, 1364, 1364, 1364, 1364, 1365, 1364, 1364, 1364, 1364, 1364, 1364, 1364, 1364, 1364, 1364, 1364, 1363, 1363, 1363, 1363, 1362, 1362, 1362, 1362, 1361, 1361, 1361, 1360, 1360, 1359, 1359, 1359, 1358, 1358, 1357, 1357, 1356, 1356, 1355, 1354, 1354, 1353, 1353, 1352, 1351, 1351, 1350, 1349, 1349, 1348, 1347, 1346, 1346, 1345, 1344, 1343, 1342, 1342, 1341, 1340, 1339, 1338, 1337, 1336, 1335, 1334, 1333, 1332, 1331, 1330, 1329, 1328, 1327, 1326, 1325, 1323, 1322, 1321, 1320, 1319, 1318, 1316, 1315, 1314, 1313, 1311, 1310, 1309, 1307, 1306, 1305, 1303, 1302, 1300, 1299, 1298, 1296, 1295, 1293, 1292, 1290, 1289, 1287, 1285, 1284, 1282, 1281, 1279, 1277, 1276, 1274, 1273, 1271, 1269, 1267, 1266, 1264, 1262, 1260, 1259, 1257, 1255, 1253, 1251, 1249, 1248, 1246, 1244, 1242, 1240, 1238, 1236, 1234, 1232, 1230, 1228, 1226, 1224, 1222, 1220, 1218, 1216, 1214, 1212, 1210, 1207, 1205, 1203, 1201, 1199, 1197, 1194, 1192, 1190, 1188, 1185, 1183, 1181, 1179, 1176, 1174, 1172, 1169, 1167, 1165, 1162, 1160, 1157, 1155, 1153, 1150, 1148, 1145, 1143, 1140, 1138, 1135, 1133, 1130, 1128, 1125, 1123, 1120, 1118, 1115, 1112, 1110, 1107, 1105, 1102, 1099, 1097, 1094, 1091, 1089, 1086, 1083, 1080, 1078, 1075, 1072, 1069, 1067, 1064, 1061, 1058, 1056, 1053, 1050, 1047, 1044, 1041, 1039, 1036, 1033, 1030, 1027, 1024, 1021, 1018, 1015, 1013, 1010, 1007, 1004, 1001, 998, 995, 992, 989, 986, 983, 980, 977, 974, 971, 968, 965, 962, 959, 956, 952, 949, 946, 943, 940, 937, 934, 931, 928, 924, 921, 918, 915, 912, 909, 906, 902, 899, 896, 893, 890, 887, 883, 880, 877, 874, 870, 867, 864, 861, 858, 854, 851, 848, 845, 841, 838, 835, 832, 828, 825, 822, 818, 815, 812, 809, 805, 802, 799, 795, 792, 789, 785, 782, 779, 776, 772, 769, 766, 762, 759, 756, 752, 749, 746, 742, 739, 736, 732, 729, 726, 722, 719, 715, 712, 709, 705, 702, 699, 695, 692, 689, 685, 682, 679, 675, 672, 669, 665, 662, 659, 655, 652, 649, 645, 642, 638, 635, 632, 628, 625, 622, 618, 615, 612, 608, 605, 602, 598, 595, 592, 588, 585, 582, 579, 575, 572, 569, 565, 562, 559, 555, 552, 549, 546, 542, 539, 536, 532, 529, 526, 523, 519, 516, 513, 510, 506, 503, 500, 497, 494, 490, 487, 484, 481, 477, 474, 471, 468, 465, 462, 458, 455, 452, 449, 446, 443, 440, 436, 433, 430, 427, 424, 421, 418, 415, 412, 408, 405, 402, 399, 396, 393, 390, 387, 384, 381, 378, 375, 372, 369, 366, 363, 360, 357, 354, 351, 349, 346, 343, 340, 337, 334, 331, 328, 325, 323, 320, 317, 314, 311, 308, 306, 303, 300, 297, 295, 292, 289, 286, 284, 281, 278, 275, 273, 270, 267, 265, 262, 259, 257, 254, 252, 249, 246, 244, 241, 239, 236, 234, 231, 229, 226, 224, 221, 219, 216, 214, 211, 209, 207, 204, 202, 199, 197, 195, 192, 190, 188, 185, 183, 181, 179, 176, 174, 172, 170, 167, 165, 163, 161, 159, 157, 154, 152, 150, 148, 146, 144, 142, 140, 138, 136, 134, 132, 130, 128, 126, 124, 122, 120, 118, 116, 115, 113, 111, 109, 107, 105, 104, 102, 100, 98, 97, 95, 93, 91, 90, 88, 87, 85, 83, 82, 80, 79, 77, 75, 74, 72, 71, 69, 68, 66, 65, 64, 62, 61, 59, 58, 57, 55, 54, 53, 51, 50, 49, 48, 46, 45, 44, 43, 42, 41, 39, 38, 37, 36, 35, 34, 33, 32, 31, 30, 29, 28, 27, 26, 25, 24, 23, 22, 22, 21, 20, 19, 18, 18, 17, 16, 15, 15, 14, 13, 13, 12, 11, 11, 10, 10, 9, 8, 8, 7, 7, 6, 6, 5, 5, 5, 4, 4, 3, 3, 3, 2, 2, 2, 2, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
};

void setup(void) {
  Serial.begin(9600);
  // Activate DAC and set output voltage to zero
  dac.begin(0x62);
  dac.setVoltage(0,false);
  // Setup digital lines and close all relays
  for (int p=2; p<10; p++) {
    pinMode(p,OUTPUT);
    digitalWrite(p,HIGH);
  }
}

void loop(void) {
  uint16_t i;

  // State 0: Activate one relay
  if (state == 0) {
    // Close all relays
    for (int p=9; p>1; p--) {
      digitalWrite(p,HIGH);
    }
    // Open one relay
    digitalWrite(outPin, LOW);
    outPin--;
    // Wait a bit for any settling after the relay switch
    delay(switchingDelay);     
    // Go to the next state
    state++;
  }

  // State 2: Send the driving signal
  if (state == 1) {
    // Push out the lookup table values to send the driving signal
    if (outPin > 4)  {
      for (i = 0; i < 1280; i++)
      {
        dac.setVoltage(pgm_read_word(&(COS_Lookup_12bit[i])), false);
      }
    }
    if (outPin < 5)  {
      for (i = 0; i < 1280; i++)
      {
        dac.setVoltage(pgm_read_word(&(COS_Lookup_12bit_thirdScale[i])), false);
      }
    }

    // If we're at the end of the signal
    if (i == 1280) {
      state++;            // Go to the next state
    }
  }

  // State 2: Delay before the next driver signal
  if (state == 2) {
    delay(ISI);
    trialIndex++;     // Incrememnt trial number
    // If we've sent the correct number of signals
    if (trialIndex == numTrials) {
      trialIndex = 0;     // Reset trial number
      // If we're not on the last relay
      if (outPin > lastPin-1) {
        state = 0;          // Go to the relay shift state
      } else {
        state = 3;          // Go to the end state
      }
    }
    // If we still have trials to send
    else {
      state = 1;          // Present the next driver signal
    }
  }

  // State 3: End state 
  if (state == 3) {
    // Close all relays
    for (int p=9; p>1; p--) {
      digitalWrite(p,HIGH);
    }
  }
}

